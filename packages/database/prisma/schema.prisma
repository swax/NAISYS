generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model context_log {
  id          String      @id // ULID
  user_id     String
  run_id      Int
  session_id  Int
  role        String
  source      String
  type        String
  message     String
  date        DateTime
  users       users       @relation("context_log_user", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  run_session run_session @relation(fields: [user_id, run_id, session_id], references: [user_id, run_id, session_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([id(sort: Desc)], map: "idx_context_log_id_desc")
  @@index([user_id], map: "idx_context_log_user_id")
  @@index([user_id, run_id, session_id], map: "idx_context_log_run_session")
}

model costs {
  id                 String      @id // ULID
  user_id            String
  run_id             Int
  session_id         Int
  source             String
  model              String
  cost               Float?      @default(0)
  input_tokens       Int?        @default(0)
  output_tokens      Int?        @default(0)
  cache_write_tokens Int?        @default(0)
  cache_read_tokens  Int?        @default(0)
  updated_at         DateTime    @updatedAt
  users              users       @relation("costs_user", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  run_session        run_session @relation(fields: [user_id, run_id, session_id], references: [user_id, run_id, session_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([id(sort: Desc)], map: "idx_costs_id_desc")
  @@index([user_id], map: "idx_costs_user_id")
  @@index([user_id, run_id, session_id], map: "idx_costs_run_session")
  @@index([user_id, run_id, session_id, source, model], map: "idx_costs_aggregation_key")
}

model mail_thread_members {
  id           String       @id // ULID
  thread_id    String
  user_id      String
  new_msg_id   String       @default("")
  archived     Int          @default(0)
  updated_by   String?
  updated_at   DateTime     @updatedAt
  users        users        @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updated_user users?       @relation("mail_thread_members_updated_by", fields: [updated_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  mail_threads mail_threads @relation(fields: [thread_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([thread_id, user_id], map: "unq_mail_thread_members_thread_id_user_id")
  @@index([thread_id], map: "idx_mail_thread_members_thread_id")
}

model mail_thread_messages {
  id           String       @id // ULID
  thread_id    String
  user_id      String
  message      String
  date         DateTime
  users        users        @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  mail_threads mail_threads @relation(fields: [thread_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([thread_id], map: "idx_mail_thread_messages_thread_id")
  @@index([id(sort: Desc)], map: "idx_mail_thread_messages_id_desc")
}

model mail_threads {
  id                   String                 @id // ULID
  subject              String
  token_count          Int                    @default(0)
  updated_by           String?
  updated_at           DateTime               @updatedAt
  updated_user         users?                 @relation("mail_threads_updated_by", fields: [updated_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  mail_thread_members  mail_thread_members[]
  mail_thread_messages mail_thread_messages[]

  @@index([id(sort: Desc)], map: "idx_mail_threads_id_desc")
}

model users {
  id                           String                 @id // ULID
  username                     String                 @unique(map: "unq_users_username")
  title                        String
  agent_path                   String                 @unique(map: "unq_users_agent_path")
  lead_username                String?
  config                       String                 @default("{}")
  host_id                      String?
  updated_at                   DateTime               @updatedAt
  host                         hosts?                 @relation(fields: [host_id], references: [id])
  mail_thread_members          mail_thread_members[]
  mail_thread_members_updated  mail_thread_members[]  @relation("mail_thread_members_updated_by")
  mail_thread_messages         mail_thread_messages[]
  mail_threads_updated         mail_threads[]         @relation("mail_threads_updated_by")
  run_sessions                 run_session[]
  context_logs                 context_log[]          @relation("context_log_user")
  costs                        costs[]                @relation("costs_user")
  user_notifications           user_notifications?

  @@index([host_id], map: "idx_users_host_id")
}

model user_notifications {
  user_id        String    @id
  latest_mail_id String    @default("")
  latest_log_id  String    @default("")
  /**
   * Not the same as modified date, for example an agent can receive mail while not being active
   */
  last_active    DateTime?
  updated_at     DateTime  @updatedAt
  users          users     @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model run_session {
  user_id       String
  run_id        Int
  session_id    Int
  start_date    DateTime
  last_active   DateTime
  model_name    String
  latest_log_id String        @default("")
  total_lines   Int           @default(0)
  total_cost    Float         @default(0)
  updated_at    DateTime      @updatedAt
  users         users         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  context_logs  context_log[]
  costs         costs[]

  @@id([user_id, run_id, session_id])
  @@index([user_id], map: "idx_run_session_user_id")
  @@index([last_active], map: "idx_run_session_last_active")
}

model schema_version {
  id      Int      @id @default(1)
  version Int      @unique(map: "unq_schema_version_version")
  updated DateTime
}

model hosts {
  id         String   @id // ULID
  name       String   @unique(map: "unq_hosts_name") // NAISYS_HOSTNAME
  updated_at DateTime @updatedAt
  users      users[]
}
