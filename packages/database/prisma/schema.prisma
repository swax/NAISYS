generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model context_log {
  id          String      @id // ULID
  user_id     String
  run_id      Int
  session_id  Int
  host_id     String? // Which host generated this log
  role        String
  source      String
  type        String
  message     String
  created_at  DateTime    @default(now())
  users       users       @relation("context_log_user", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  run_session run_session @relation(fields: [user_id, run_id, session_id], references: [user_id, run_id, session_id], onDelete: NoAction, onUpdate: NoAction)
  host        hosts?      @relation(fields: [host_id], references: [id])

  @@index([id(sort: Desc)], map: "idx_context_log_id_desc") // ORDER BY id DESC in runsService.getContextLog
  @@index([user_id, run_id, session_id], map: "idx_context_log_run_session") // WHERE user_id, run_id, session_id in runsService.getContextLog
}

model costs {
  id                 String      @id // ULID
  user_id            String
  run_id             Int
  session_id         Int
  host_id            String? // Which host incurred this cost
  source             String
  model              String
  cost               Float?      @default(0)
  input_tokens       Int?        @default(0)
  output_tokens      Int?        @default(0)
  cache_write_tokens Int?        @default(0)
  cache_read_tokens  Int?        @default(0)
  created_at         DateTime    @default(now())
  users              users       @relation("costs_user", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  run_session        run_session @relation(fields: [user_id, run_id, session_id], references: [user_id, run_id, session_id], onDelete: NoAction, onUpdate: NoAction)
  host               hosts?      @relation(fields: [host_id], references: [id])

  @@index([id(sort: Desc)], map: "idx_costs_id_desc") // ORDER BY id DESC in costTracker.findFirst for aggregation window check
  @@index([user_id], map: "idx_costs_user_id") // Optional WHERE user_id filter in aggregate/groupBy queries
  @@index([user_id, run_id, session_id, source, model], map: "idx_costs_aggregation_key") // Cost aggregation lookups in costTracker
}

model mail_messages {
  id                 String               @id // ULID
  from_user_id       String
  host_id            String? // Sender's host
  subject            String
  body               String
  created_at         DateTime             @default(now())
  from_user          users                @relation("mail_messages_from_user", fields: [from_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host               hosts?               @relation(fields: [host_id], references: [id])
  recipients         mail_recipients[]

  @@index([id(sort: Desc)], map: "idx_mail_messages_id_desc") // ORDER BY id DESC in supervisor mailService pagination
  @@index([from_user_id], map: "idx_mail_messages_from_user_id") // WHERE from_user_id in sent messages filter
  @@index([created_at(sort: Desc)], map: "idx_mail_messages_created_at") // ORDER BY created_at DESC in listMessages and searchMessages
}

model mail_recipients {
  id          String        @id // ULID
  message_id  String
  user_id     String
  type        String // "to", "cc", "bcc"
  read_at     DateTime?
  archived_at DateTime?
  created_at  DateTime      @default(now())
  message     mail_messages @relation(fields: [message_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user        users         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([message_id], map: "idx_mail_recipients_message_id") // JOIN from mail_messages includes
  @@index([user_id, message_id(sort: Desc)], map: "idx_mail_recipients_user_id") // groupBy user_id + MAX(message_id) in supervisor agentService, also recipients.some({ user_id })
}

model users {
  id                 String              @id // ULID
  username           String
  title              String
  agent_path         String              @unique(map: "unq_users_agent_path")
  lead_user_id       String?
  config             String              @default("{}")
  created_at         DateTime            @default(now())
  updated_at         DateTime            @updatedAt
  deleted_at         DateTime? // Soft delete for deactivated agents
  lead_user          users?              @relation("lead_to_subagents", fields: [lead_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subagents          users[]             @relation("lead_to_subagents")
  mail_messages_sent mail_messages[]     @relation("mail_messages_from_user")
  mail_recipients    mail_recipients[]
  run_sessions       run_session[]
  context_logs       context_log[]       @relation("context_log_user")
  costs              costs[]             @relation("costs_user")
  user_notifications user_notifications?
  user_hosts         user_hosts[]
}

model user_notifications {
  user_id        String         @id
  latest_host_id String?
  latest_log_id  String         @default("")
  latest_mail_id String         @default("")
  last_active    DateTime?
  updated_at     DateTime       @updatedAt
  users          users          @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host           hosts?         @relation(fields: [latest_host_id], references: [id])
}

model user_hosts {
  user_id    String
  host_id    String
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host       hosts    @relation(fields: [host_id], references: [id])

  @@id([user_id, host_id])
}

model run_session {
  user_id       String
  run_id        Int
  session_id    Int
  host_id       String? // Which host ran this session
  last_active   DateTime
  model_name    String
  latest_log_id String        @default("")
  total_lines   Int           @default(0)
  total_cost    Float         @default(0)
  created_at    DateTime      @default(now())
  updated_at    DateTime      @updatedAt
  users         users         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host          hosts?        @relation(fields: [host_id], references: [id])
  context_logs  context_log[]
  costs         costs[]

  @@id([user_id, run_id, session_id])
  @@index([user_id, last_active(sort: Desc)], map: "idx_run_session_user_active") // WHERE user_id ORDER BY last_active DESC in supervisor runsService pagination
}

model schema_version {
  id      Int      @id @default(1)
  version Int      @unique(map: "unq_schema_version_version")
  updated DateTime
}

model hosts {
  id                 String               @id
  name               String               @unique(map: "unq_hosts_name") // NAISYS_HOSTNAME
  last_active        DateTime?
  created_at         DateTime             @default(now())
  user_notifications user_notifications[]
  mail_messages      mail_messages[]
  run_sessions       run_session[]
  costs              costs[]
  context_logs       context_log[]
  user_hosts         user_hosts[]
}
