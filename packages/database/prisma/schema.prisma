generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model context_log {
  id          Int         @id @default(autoincrement())
  user_id     Int
  run_id      Int
  session_id  Int
  host_id     Int
  role        String
  source      String
  type        String
  message     String
  created_at  DateTime    @default(now())
  users       users       @relation("context_log_user", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  run_session run_session @relation(fields: [user_id, run_id, session_id], references: [user_id, run_id, session_id], onDelete: NoAction, onUpdate: NoAction)
  host        hosts       @relation(fields: [host_id], references: [id])

  @@index([user_id, run_id, session_id], map: "idx_context_log_user_run_session") // WHERE user_id, run_id, session_id in runsService.getContextLog
}

model costs {
  id                 Int         @id @default(autoincrement())
  user_id            Int
  run_id             Int
  session_id         Int
  host_id            Int
  source             String
  model              String
  cost               Float?      @default(0)
  input_tokens       Int?        @default(0)
  output_tokens      Int?        @default(0)
  cache_write_tokens Int?        @default(0)
  cache_read_tokens  Int?        @default(0)
  created_at         DateTime    @default(now())
  users              users       @relation("costs_user", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  run_session        run_session @relation(fields: [user_id, run_id, session_id], references: [user_id, run_id, session_id], onDelete: NoAction, onUpdate: NoAction)
  host               hosts       @relation(fields: [host_id], references: [id])

  @@index([created_at], map: "idx_costs_created_at") // ORDER BY created_at DESC, WHERE created_at >= in aggregate time range filtering
  @@index([user_id], map: "idx_costs_user_id") // Optional WHERE user_id filter in aggregate spend limit queries
  @@index([user_id, run_id, session_id, source, model], map: "idx_costs_user_run_session_source_model") // WHERE user_id, run_id, session_id, source, model in hubCostService findFirst
}

model mail_messages {
  id           Int               @id @default(autoincrement())
  from_user_id Int
  host_id      Int? // Sender's host
  subject      String
  body         String
  created_at   DateTime          @default(now())
  from_user    users             @relation("mail_messages_from_user", fields: [from_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host         hosts?            @relation(fields: [host_id], references: [id])
  recipients   mail_recipients[]

  @@index([from_user_id], map: "idx_mail_messages_from_user_id") // WHERE from_user_id in sent messages filter
  @@index([created_at(sort: Desc)], map: "idx_mail_messages_created_at_desc") // ORDER BY created_at DESC in listMessages and searchMessages
}

model mail_recipients {
  id          Int           @id @default(autoincrement())
  message_id  Int
  user_id     Int
  type        String // "to", "cc", "bcc"
  read_at     DateTime?
  archived_at DateTime?
  created_at  DateTime      @default(now())
  message     mail_messages @relation(fields: [message_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user        users         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([message_id, user_id], map: "idx_mail_recipients_message_user") // JOIN from mail_messages includes, WHERE message_id + user_id in read/archive updateMany
  @@index([user_id, message_id(sort: Desc)], map: "idx_mail_recipients_user_message_desc") // recipients.some({ user_id }) in mail list/search/unread filtering
}

model users {
  id                 Int                 @id @default(autoincrement())
  uuid               String              @unique
  username           String
  title              String
  agent_path         String              @unique(map: "unq_users_agent_path")
  lead_user_id       Int?
  config             String              @default("{}")
  created_at         DateTime            @default(now())
  updated_at         DateTime            @updatedAt
  deleted_at         DateTime? // Soft delete for deactivated agents
  lead_user          users?              @relation("lead_to_subagents", fields: [lead_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subagents          users[]             @relation("lead_to_subagents")
  mail_messages_sent mail_messages[]     @relation("mail_messages_from_user")
  mail_recipients    mail_recipients[]
  run_sessions       run_session[]
  context_logs       context_log[]       @relation("context_log_user")
  costs              costs[]             @relation("costs_user")
  user_notifications user_notifications?
  user_hosts         user_hosts[]

  @@index([username], map: "idx_users_username") // WHERE username in hubMailService recipient resolution, agentConfigService user lookup
}

model user_notifications {
  user_id        Int       @id
  latest_host_id Int?
  latest_log_id  Int       @default(0)
  latest_mail_id Int       @default(0)
  last_active    DateTime?
  updated_at     DateTime  @updatedAt
  users          users     @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host           hosts?    @relation(fields: [latest_host_id], references: [id])
}

model user_hosts {
  user_id    Int
  host_id    Int
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host       hosts    @relation(fields: [host_id], references: [id])

  @@id([user_id, host_id])
}

model run_session {
  user_id       Int
  run_id        Int
  session_id    Int
  host_id       Int
  last_active   DateTime
  model_name    String
  latest_log_id Int           @default(0)
  total_lines   Int           @default(0)
  total_cost    Float         @default(0)
  created_at    DateTime      @default(now())
  updated_at    DateTime      @updatedAt
  users         users         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host          hosts         @relation(fields: [host_id], references: [id])
  context_logs  context_log[]
  costs         costs[]

  @@id([user_id, run_id, session_id])
  @@index([run_id(sort: Desc)], map: "idx_run_session_run_id_desc") // ORDER BY run_id DESC in hubRunService to find max run_id for new runs
  @@index([user_id, last_active(sort: Desc)], map: "idx_run_session_user_last_active_desc") // WHERE user_id ORDER BY last_active DESC in supervisor runsService pagination
}

model schema_version {
  id      Int      @id @default(1)
  version Int      @unique(map: "unq_schema_version_version")
  updated DateTime
}

model hosts {
  id                 Int                  @id @default(autoincrement())
  name               String               @unique(map: "unq_hosts_name") // NAISYS_HOSTNAME
  last_active        DateTime?
  created_at         DateTime             @default(now())
  user_notifications user_notifications[]
  mail_messages      mail_messages[]
  run_sessions       run_session[]
  costs              costs[]
  context_logs       context_log[]
  user_hosts         user_hosts[]
}

model web_users {
  id                 Int       @id @default(autoincrement())
  uuid               String    @unique
  username           String    @unique
  password_hash      String
  session_token_hash String?
  session_expires_at DateTime?
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
}
