generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = "file:${env('NAISYS_FOLDER')}/database/naisys.sqlite" // Hardcode the db path here to use Prisma studio 
}

model context_log {
  id          Int         @id @default(autoincrement())
  user_id     Int
  run_id      Int
  session_id  Int
  role        String
  source      String
  type        String
  message     String
  date        String
  users       users       @relation("context_log_user", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  run_session run_session @relation(fields: [user_id, run_id, session_id], references: [user_id, run_id, session_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([id(sort: Desc)], map: "idx_context_log_id_desc")
  @@index([user_id], map: "idx_context_log_user_id")
  @@index([user_id, run_id, session_id], map: "idx_context_log_run_session")
}

model costs {
  id                 Int         @id @default(autoincrement())
  date               String
  user_id            Int
  run_id             Int
  session_id         Int
  subagent           String?
  source             String
  model              String
  cost               Float?      @default(0)
  input_tokens       Int?        @default(0)
  output_tokens      Int?        @default(0)
  cache_write_tokens Int?        @default(0)
  cache_read_tokens  Int?        @default(0)
  users              users       @relation("costs_user", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  run_session        run_session @relation(fields: [user_id, run_id, session_id], references: [user_id, run_id, session_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([id(sort: Desc)], map: "idx_costs_id_desc")
  @@index([user_id], map: "idx_costs_user_id")
  @@index([user_id, run_id, session_id], map: "idx_costs_run_session")
  @@index([date], map: "idx_costs_date")
}

model dream_log {
  id          Int         @id @default(autoincrement())
  user_id     Int
  run_id      Int
  session_id  Int
  date        String
  dream       String
  users       users       @relation("dream_log_user", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  run_session run_session @relation(fields: [user_id, run_id, session_id], references: [user_id, run_id, session_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([id(sort: Desc)], map: "idx_dream_log_id_desc")
  @@index([user_id], map: "idx_dream_log_user_id")
  @@index([user_id, run_id, session_id], map: "idx_dream_log_run_session")
}

model thread_members {
  id         Int     @id @default(autoincrement())
  thread_id  Int
  user_id    Int
  new_msg_id Int     @default(-1)
  archived   Int     @default(0)
  users      users   @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  threads    threads @relation(fields: [thread_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([thread_id, user_id], map: "unq_thread_members_thread_id_user_id")
  @@index([thread_id], map: "idx_thread_members_thread_id")
}

model thread_messages {
  id        Int     @id @default(autoincrement())
  thread_id Int
  user_id   Int
  message   String
  date      String
  users     users   @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  threads   threads @relation(fields: [thread_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([thread_id], map: "idx_thread_messages_thread_id")
  @@index([id(sort: Desc)], map: "idx_thread_messages_id_desc")
}

model threads {
  id              Int               @id @default(autoincrement())
  subject         String
  token_count     Int               @default(0)
  thread_members  thread_members[]
  thread_messages thread_messages[]

  @@index([id(sort: Desc)], map: "idx_threads_id_desc")
}

model users {
  id              Int               @id @default(autoincrement())
  username        String            @unique(map: "unq_users_username")
  title           String
  agent_path      String            @unique(map: "unq_users_agent_path")
  lead_username   String?
  thread_members  thread_members[]
  thread_messages thread_messages[]
  run_sessions    run_session[]
  context_logs    context_log[]     @relation("context_log_user")
  costs           costs[]           @relation("costs_user")
  dream_logs      dream_log[]       @relation("dream_log_user")
}

model run_session {
  user_id      Int
  run_id       Int
  session_id   Int
  start_date   String
  last_active  String
  model_name   String
  total_lines  Int           @default(0)
  total_cost   Float         @default(0)
  users        users         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  context_logs context_log[]
  costs        costs[]
  dream_logs   dream_log[]

  @@id([user_id, run_id, session_id])
  @@index([user_id], map: "idx_run_session_user_id")
  @@index([last_active], map: "idx_run_session_last_active")
}
