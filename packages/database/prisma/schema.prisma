generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model context_log {
  id          String      @id // ULID
  user_id     String
  run_id      Int
  session_id  Int
  host_id     String? // Which host generated this log
  role        String
  source      String
  type        String
  message     String
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  users       users       @relation("context_log_user", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  run_session run_session @relation(fields: [user_id, run_id, session_id], references: [user_id, run_id, session_id], onDelete: NoAction, onUpdate: NoAction)
  host        hosts?      @relation(fields: [host_id], references: [host_id])

  @@index([id(sort: Desc)], map: "idx_context_log_id_desc")
  @@index([user_id], map: "idx_context_log_user_id")
  @@index([user_id, run_id, session_id], map: "idx_context_log_run_session")
  @@index([host_id], map: "idx_context_log_host_id")
}

model costs {
  id                 String      @id // ULID
  user_id            String
  run_id             Int
  session_id         Int
  host_id            String? // Which host incurred this cost
  source             String
  model              String
  cost               Float?      @default(0)
  input_tokens       Int?        @default(0)
  output_tokens      Int?        @default(0)
  cache_write_tokens Int?        @default(0)
  cache_read_tokens  Int?        @default(0)
  created_at         DateTime    @default(now())
  updated_at         DateTime    @updatedAt
  users              users       @relation("costs_user", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  run_session        run_session @relation(fields: [user_id, run_id, session_id], references: [user_id, run_id, session_id], onDelete: NoAction, onUpdate: NoAction)
  host               hosts?      @relation(fields: [host_id], references: [host_id])

  @@index([id(sort: Desc)], map: "idx_costs_id_desc")
  @@index([user_id], map: "idx_costs_user_id")
  @@index([user_id, run_id, session_id], map: "idx_costs_run_session")
  @@index([user_id, run_id, session_id, source, model], map: "idx_costs_aggregation_key")
  @@index([host_id], map: "idx_costs_host_id")
}

model mail_messages {
  id           String            @id // ULID
  from_user_id String
  host_id      String? // Sender's host
  subject      String
  body         String
  created_at   DateTime          @default(now())
  updated_at   DateTime          @updatedAt
  from_user    users             @relation("mail_messages_from_user", fields: [from_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host         hosts?            @relation(fields: [host_id], references: [host_id])
  recipients   mail_recipients[]
  status       mail_status[]

  @@index([id(sort: Desc)], map: "idx_mail_messages_id_desc")
  @@index([from_user_id], map: "idx_mail_messages_from_user_id")
  @@index([host_id], map: "idx_mail_messages_host_id")
}

model mail_recipients {
  id         String        @id // ULID
  message_id String
  user_id    String
  host_id    String? // Sender's host (same as message)
  type       String // "to", "cc", "bcc"
  created_at DateTime      @default(now())
  updated_at DateTime      @updatedAt
  message    mail_messages @relation(fields: [message_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user       users         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host       hosts?        @relation(fields: [host_id], references: [host_id])

  @@index([message_id], map: "idx_mail_recipients_message_id")
  @@index([user_id], map: "idx_mail_recipients_user_id")
  @@index([host_id], map: "idx_mail_recipients_host_id")
}

model mail_status {
  id          String        @id // ULID
  message_id  String
  user_id     String
  host_id     String? // Recipient's host
  read_at     DateTime?
  archived_at DateTime?
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt
  message     mail_messages @relation(fields: [message_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user        users         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host        hosts?        @relation(fields: [host_id], references: [host_id])

  @@unique([message_id, user_id], map: "unq_mail_status_message_user")
  @@index([user_id], map: "idx_mail_status_user_id")
  @@index([host_id], map: "idx_mail_status_host_id")
}

model users {
  id                 String              @id // ULID
  username           String              @unique(map: "unq_users_username")
  title              String
  agent_path         String              @unique(map: "unq_users_agent_path")
  lead_username      String?
  config             String              @default("{}")
  host_id            String?
  created_at         DateTime            @default(now())
  updated_at         DateTime            @updatedAt
  host               hosts?              @relation(fields: [host_id], references: [host_id])
  mail_messages_sent mail_messages[]     @relation("mail_messages_from_user")
  mail_recipients    mail_recipients[]
  mail_status        mail_status[]
  run_sessions       run_session[]
  context_logs       context_log[]       @relation("context_log_user")
  costs              costs[]             @relation("costs_user")
  user_notifications user_notifications?

  @@index([host_id], map: "idx_users_host_id")
}

model user_notifications {
  user_id        String    @id
  host_id        String? // Same as user's host
  latest_mail_id String    @default("")
  latest_log_id  String    @default("")
  /**
   * Not the same as modified date, for example an agent can receive mail while not being active
   */
  last_active    DateTime?
  updated_at     DateTime  @updatedAt
  users          users     @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host           hosts?    @relation(fields: [host_id], references: [host_id])

  @@index([host_id], map: "idx_user_notifications_host_id")
}

model run_session {
  user_id       String
  run_id        Int
  session_id    Int
  host_id       String? // Which host ran this session
  last_active   DateTime
  model_name    String
  latest_log_id String        @default("")
  total_lines   Int           @default(0)
  total_cost    Float         @default(0)
  created_at    DateTime      @default(now())
  updated_at    DateTime      @updatedAt
  users         users         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  host          hosts?        @relation(fields: [host_id], references: [host_id])
  context_logs  context_log[]
  costs         costs[]

  @@id([user_id, run_id, session_id])
  @@index([user_id], map: "idx_run_session_user_id")
  @@index([last_active], map: "idx_run_session_last_active")
  @@index([host_id], map: "idx_run_session_host_id")
}

model schema_version {
  id      Int      @id @default(1)
  version Int      @unique(map: "unq_schema_version_version")
  updated DateTime
}

model hosts {
  host_id            String               @id @map("host_id") // ULID - same column name as FK in other tables
  name               String               @unique(map: "unq_hosts_name") // NAISYS_HOSTNAME
  created_at         DateTime             @default(now())
  updated_at         DateTime             @updatedAt
  users              users[]
  user_notifications user_notifications[]
  mail_messages      mail_messages[]
  mail_recipients    mail_recipients[]
  mail_status        mail_status[]
  run_sessions       run_session[]
  costs              costs[]
  context_logs       context_log[]
}
