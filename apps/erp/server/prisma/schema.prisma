datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

model PlanningOrder {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  name        String
  description String   @default("")
  status      String   @default("active") // "active" | "archived"
  createdById Int      @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedById Int      @map("updated_by")
  updatedAt   DateTime @updatedAt @map("updated_at")

  createdBy  User                    @relation("planOrderCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy  User                    @relation("planOrderUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)
  revisions  PlanningOrderRevision[]
  execOrders ExecOrder[]

  @@index([status]) // LIST filter in planning-orders.ts
  @@index([createdAt]) // LIST orderBy in planning-orders.ts
  @@map("plan_orders")
}

model PlanningOrderRevision {
  id            Int       @id @default(autoincrement())
  planOrderId   Int       @map("plan_order_id")
  revNo         Int       @map("rev_no")
  status        String    @default("draft") // "draft" | "approved" | "obsolete"
  notes         String?
  changeSummary String?   @map("change_summary")
  createdAt     DateTime  @default(now()) @map("created_at")
  createdById   Int       @map("created_by")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  updatedById   Int       @map("updated_by")
  createdBy  User          @relation("planOrderRevCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy  User          @relation("planOrderRevUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)
  order      PlanningOrder @relation(fields: [planOrderId], references: [id], onDelete: Restrict)
  execOrders ExecOrder[]

  @@unique([planOrderId, revNo])
  @@map("plan_order_revs")
}

model ExecOrder {
  id               Int       @id @default(autoincrement())
  orderNo          Int       @map("order_no")
  planOrderId      Int       @map("plan_order_id")
  planOrderRevId   Int       @map("plan_order_rev_id")
  status           String    @default("released")
  priority         String    @default("medium")
  scheduledStartAt DateTime? @map("scheduled_start_at")
  dueAt            DateTime? @map("due_at")
  releasedAt       DateTime  @default(now()) @map("released_at")
  assignedTo       String?   @map("assigned_to")
  notes            String?
  createdAt        DateTime  @default(now()) @map("created_at")
  createdById      Int       @map("created_by")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  updatedById      Int       @map("updated_by")

  createdBy    User                  @relation("execOrderCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy    User                  @relation("execOrderUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)
  planOrder    PlanningOrder         @relation(fields: [planOrderId], references: [id], onDelete: Restrict)
  planOrderRev PlanningOrderRevision @relation(fields: [planOrderRevId], references: [id], onDelete: Restrict)

  @@unique([planOrderId, orderNo])
  @@index([status]) // LIST filter in execution-orders.ts
  @@index([priority]) // LIST filter in execution-orders.ts
  @@index([createdAt]) // LIST orderBy in execution-orders.ts
  @@index([planOrderRevId]) // FK lookup for planOrderRev relation
  @@map("exec_orders")
}

model User {
  id           Int       @id @default(autoincrement())
  uuid         String    @unique
  username     String    @unique
  passwordHash String    @map("password_hash")
  title        String    @default("")
  leadUserId   Int?      @map("lead_user_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  sessionTokenHash String?   @map("session_token_hash")
  sessionExpiresAt DateTime? @map("session_expires_at")

  leadUser  User?  @relation("lead_to_subagents", fields: [leadUserId], references: [id], onDelete: NoAction)
  subagents User[] @relation("lead_to_subagents")

  planOrdersCreated    PlanningOrder[]         @relation("planOrderCreatedBy")
  planOrdersUpdated    PlanningOrder[]         @relation("planOrderUpdatedBy")
  planOrderRevsCreated PlanningOrderRevision[] @relation("planOrderRevCreatedBy")
  planOrderRevsUpdated PlanningOrderRevision[] @relation("planOrderRevUpdatedBy")
  execOrdersCreated    ExecOrder[]             @relation("execOrderCreatedBy")
  execOrdersUpdated    ExecOrder[]             @relation("execOrderUpdatedBy")
  auditLogs            AuditLog[]

  @@map("users")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  entityType String   @map("entity_type")
  entityId   Int      @map("entity_id")
  action     String
  field      String
  oldValue   String?  @map("old_value")
  newValue   String?  @map("new_value")
  userId     Int      @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([entityType, entityId])
  @@map("audit_log")
}
