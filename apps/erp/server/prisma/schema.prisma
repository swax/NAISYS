datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

model PlanningOrder {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  name        String
  description String   @default("")
  status      String   @default("active") // "active" | "archived"
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedBy   String   @map("updated_by")
  updatedAt   DateTime @updatedAt @map("updated_at")

  revisions  PlanningOrderRevision[]
  execOrders ExecOrder[]

  @@index([status]) // LIST filter in planning-orders.ts
  @@index([createdAt]) // LIST orderBy in planning-orders.ts
  @@map("plan_orders")
}

model PlanningOrderRevision {
  id            Int       @id @default(autoincrement())
  planOrderId   Int       @map("plan_order_id")
  revNo         Int       @map("rev_no")
  status        String    @default("draft") // "draft" | "approved" | "obsolete"
  notes         String?
  changeSummary String?   @map("change_summary")
  createdAt     DateTime  @default(now()) @map("created_at")
  approvedAt    DateTime? @map("approved_at")

  order      PlanningOrder @relation(fields: [planOrderId], references: [id], onDelete: Restrict)
  execOrders ExecOrder[]

  @@unique([planOrderId, revNo])
  @@map("plan_order_revs")
}

model ExecOrder {
  id              Int       @id @default(autoincrement())
  orderNo         Int       @map("order_no")
  planOrderId     Int       @map("plan_order_id")
  planOrderRevId  Int       @map("plan_order_rev_id")
  status          String    @default("released")
  priority        String    @default("medium")
  scheduledStartAt DateTime? @map("scheduled_start_at")
  dueAt           DateTime? @map("due_at")
  releasedAt      DateTime  @default(now()) @map("released_at")
  startedAt       DateTime? @map("started_at")
  closedAt        DateTime? @map("closed_at")
  assignedTo      String?   @map("assigned_to")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  createdBy       String    @map("created_by")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  updatedBy       String    @map("updated_by")

  planOrder    PlanningOrder         @relation(fields: [planOrderId], references: [id], onDelete: Restrict)
  planOrderRev PlanningOrderRevision @relation(fields: [planOrderRevId], references: [id], onDelete: Restrict)

  @@unique([planOrderId, orderNo])
  @@index([status]) // LIST filter in execution-orders.ts
  @@index([priority]) // LIST filter in execution-orders.ts
  @@index([createdAt]) // LIST orderBy in execution-orders.ts
  @@index([planOrderRevId]) // FK lookup for planOrderRev relation
  @@map("exec_orders")
}
